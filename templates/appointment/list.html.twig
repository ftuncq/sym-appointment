{% extends "base.html.twig" %}

{% block title %}
	Mes rendez-vous
{% endblock %}

{% block body %}
	{% set now = "now"|date("U", "Europe/Paris") %}
	<div class="ykzkxt d6i7ks">
		<div class="d-flex">
			<div class="w-100">
				<div class="d-md-flex justify-content-md-between align-items-center spacer-section-checkout">
					<div class="flex-fill mb-6 mb-md-0">
						<h1 class="pr-md-6 bkicbc">Mes rendez-vous</h1>
					</div>
				</div>
			</div>
		</div>
		{% if appointments is empty %}
			<div class="alert alert-info mt-4">Aucun rendez-vous payé pour le moment.</div>
		{% else %}
			<div class="wwz44q">
				{% for a in appointments %}
					{% set endParis = a.endAt|date("U", "Europe/Paris") %}
					<div class="xo2a4n" data-appointment-row data-appointment-id="{{ a.id }}">
						<div class="ixxz17">
							<div
								class="space-y-1">
								{# N° de RDV / Référence #}
								<div class="hp7ucm">
									<div class="row">
										<div class="col-12 col-md-4 py-1 d-none d-md-block font-weight-bold">
											N° de rendez-vous
										</div>
										<div class="col-12 col-md-8 py-1">
											<div class="d-md-none font-weight-bold">N° de rendez-vous</div>
											<div class="d-flex justify-content-between align-items-center">
												<div class="text-truncate mr-3">
													<div class="text-truncate text-wrap">
														{{ a.number is defined and a.number ? a.number : a.id }}
													</div>
												</div>
												{% if a.status == constant('App\\Enum\\AppointmentStatus::CONFIRMED') %}
													<div>
														<a href="{{ path('app_appointment_pdf', {'id': a.id} )}}" class="btn btn-md a3awwl">
															<span>Facture PDF</span>
														</a>
													</div>
												{% endif %}
											</div>
										</div>
									</div>
								</div>
								{# Type de RDV #}
								<div class="hp7ucm">
									<div class="row">
										<div class="col-12 col-md-4 py-1 d-none d-md-block font-weight-bold">
											Type de rendez-vous
										</div>
										<div class="col-12 col-md-8 py-1">
											<div class="d-md-none font-weight-bold">Type de rendez-vous</div>
											<div class="d-flex justify-content-between align-items-center">
												<div class="text-truncate mr-3">
													<div class="text-truncate text-wrap">
														{{ a.type.name ?? '—' }}
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
								{# Prix du RDV #}
								<div class="hp7ucm">
									<div class="row">
										<div class="col-12 col-md-4 py-1 d-none d-md-block font-weight-bold">
											Prix
										</div>
										<div class="col-12 col-md-8 py-1">
											<div class="d-md-none font-weight-bold">Prix</div>
											<div class="d-flex justify-content-between align-items-center">
												<div class="text-truncate mr-3">
													<div class="text-truncate text-wrap">
														{{ (a.type.price ?? 0) | amount }}
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
								{# Début (UTC → Europe/Paris) #}
								<div class="hp7ucm">
									<div class="row">
										<div class="col-12 col-md-4 py-1 d-none d-md-block font-weight-bold">
											Débute le
										</div>
										<div class="col-12 col-md-8 py-1">
											<div class="d-md-none font-weight-bold">Débute le</div>
											<div class="d-flex justify-content-between align-items-center">
												<div class="text-truncate mr-3">
													<div class="text-truncate text-wrap">
														<span data-appointment-start-label>
															{{ a.startAt|format_datetime('long', 'short', timezone='Europe/Paris', locale='fr') }}
														</span>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
								{# Fin (UTC → Europe/Paris) #}
								<div class="hp7ucm">
									<div class="row">
										<div class="col-12 col-md-4 py-1 d-none d-md-block font-weight-bold">
											Se termine le
										</div>
										<div class="col-12 col-md-8 py-1">
											<div class="d-md-none font-weight-bold">Se termine le</div>
											<div class="d-flex justify-content-between align-items-center">
												<div class="text-truncate mr-3">
													<div class="text-truncate text-wrap">
														<span data-appointment-end-label>
															{{ a.endAt|format_datetime('long', 'short', timezone='Europe/Paris', locale='fr') }}
														</span>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
								{# Statut (enum) + action Annuler / Modifier #}
								<div class="hp7ucm">
									<div class="row">
										<div class="col-12 col-md-4 py-1 d-none d-md-block font-weight-bold">
											Statut
										</div>
										<div class="col-12 col-md-8 py-1">
											<div class="d-md-none font-weight-bold">Statut</div>
											<div class="d-flex justify-content-between align-items-start align-items-sm-center flex-sm-row flex-column gap-2">
												<div class="text-truncate mr-3">
													<div class="text-truncate text-wrap">
														{% if a.status == constant('App\\Enum\\AppointmentStatus::CONFIRMED')  %}
															<span class="badge text-bg-success">Payé</span>
														{% elseif a.status == constant('App\\Enum\\AppointmentStatus::CANCELED') %}
															<span class="badge text-bg-danger">{{ a.status.label }}</span>
														{% else %}
															<span class="badge text-bg-secondary">{{ a.status.label }}</span>
														{% endif %}
													</div>
												</div>
												{% include "appointment/_actions.html.twig" with { a: a } %}
											</div>
										</div>
									</div>
								</div>
								{# Lien de visioconférence #}
								{% if a.visioUrl and a.status != constant('App\\Enum\\AppointmentStatus::CANCELED') and endParis > now %}
									<div class="hp7ucm">
										<div class="row">
											<div class="col-12 col-md-4 py-1 d-none d-md-block font-weight-bold">
												Lien de visioconférence
											</div>
											<div class="col-12 col-md-8 py-1">
												<div class="d-md-none font-weight-bold">Lien de visioconférence</div>
												<div class="d-flex justify-content-between align-items-start align-items-sm-center flex-sm-row flex-column gap-2">
													<div class="text-truncate mr-3">
														<a href="{{ a.visioUrl }}" target="_blank" rel="noopener noreferrer" class="btn btn-outline-primary btn-sm">
															<i class="bi bi-camera-video"></i>
															<span>Rejoindre la visioconférence</span>
														</a>
													</div>
												</div>
											</div>
										</div>
									</div>
								{% endif %}
                                {# Affichage du PDF #}
                                {% if a.pdfName and a.status != constant('App\\Enum\\AppointmentStatus::CANCELED') and now > endParis %}
									<div class="hp7ucm">
										<div class="row">
											<div class="col-12 col-md-4 py-1 d-none d-md-block font-weight-bold">
												Support PDF
											</div>
											<div class="col-12 col-md-8 py-1">
												<div class="d-md-none font-weight-bold">Support PDF</div>
												<div class="d-flex justify-content-between align-items-start align-items-sm-center flex-sm-row flex-column gap-2">
													<div class="text-truncate mr-3">
														<a href="{{ asset('doc/appointments/' ~ a.pdfName) }}" target="_blank" rel="noopener noreferrer" class="btn btn-outline-primary btn-sm">
															<i class="bi bi-file-earmark-pdf"></i>
															<span>Support PDF</span>
														</a>
													</div>
												</div>
											</div>
										</div>
									</div>
                                {% endif %}
							</div>
						</div>
					</div>
				{% endfor %}
			</div>
			<div class="mt-4">
				{% include "appointment/_cgv_summary.html.twig" with {
                    minNotice: rescheduleMinNoticeHours|default(24)
                } %}
			</div>
		{% endif %}
	</div>
{% endblock %}
